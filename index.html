<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>myPad</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; display: flex; flex-direction: column; background: #fff; font-family: sans-serif; }
        
        /* Input del Titolo: sottile e minimale */
        #title-input {
            width: 100%; border: none; outline: none;
            padding: 15px 20px 5px 20px; font-size: 14px;
            font-weight: bold; color: #888; text-transform: uppercase;
            letter-spacing: 1px; box-sizing: border-box;
        }
        #title-input:focus { color: #000; }

        /* Area di testo principale */
        #pad {
            flex: 1; width: 100%; border: none; outline: none;
            padding: 10px 20px 20px 20px; font-family: 'Courier New', monospace;
            font-size: 18px; resize: none; box-sizing: border-box;
        }

        #qr-btn {
            position: fixed; bottom: 20px; right: 20px;
            width: 45px; height: 45px; border-radius: 50%;
            background: #333; color: white; border: none;
            cursor: pointer; font-size: 18px; z-index: 100;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        #qr-container {
            position: fixed; bottom: 80px; right: 20px;
            background: white; padding: 15px; border: 1px solid #ddd;
            border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: none; text-align: center; z-index: 99;
        }
        #qr-container.show { display: block; }
        canvas { max-width: 200px; height: auto; }
        #status { position: fixed; bottom: 10px; left: 20px; font-size: 11px; color: #ccc; pointer-events: none; }
    </style>
</head>
<body>

<input type="text" id="title-input" placeholder="Titolo" spellcheck="false">
<textarea id="pad" placeholder="Inizia a scrivere..."></textarea>
<div id="status">Sincronizzato</div>

<button id="qr-btn">QR</button>
<div id="qr-container"><canvas id="qr"></canvas></div>

<script>
    const titleInput = document.getElementById('title-input');
    const pad = document.getElementById('pad');
    const qrBtn = document.getElementById('qr-btn');
    const qrContainer = document.getElementById('qr-container');
    const qrCanvas = document.getElementById('qr');

    const qr = new QRious({ element: qrCanvas, size: 250, level: 'L' });

    // Compressione
    async function compress(str) {
        const bytes = new TextEncoder().encode(str);
        const stream = new Blob([bytes]).stream();
        const compressedStream = stream.pipeThrough(new CompressionStream('deflate'));
        const arr = await new Response(compressedStream).arrayBuffer();
        return btoa(String.fromCharCode(...new Uint8Array(arr)))
            .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // Decompressione
    async function decompress(base64) {
        try {
            const b64 = base64.replace(/-/g, '+').replace(/_/g, '/');
            const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
            const stream = new Blob([bytes]).stream();
            const decompressedStream = stream.pipeThrough(new DecompressionStream('deflate'));
            return await new Response(decompressedStream).text();
        } catch (e) { return ""; }
    }

    // Gestione URL (Caricamento)
    window.addEventListener('DOMContentLoaded', async () => {
        const hash = decodeURIComponent(window.location.hash.substring(1));
        if (hash) {
            const [titlePart, contentPart] = hash.split('|');
            // Se c'è un separatore |, il primo è il titolo. Altrimenti tutto è contenuto.
            if (contentPart !== undefined) {
                titleInput.value = titlePart;
                pad.value = await decompress(contentPart);
            } else {
                pad.value = await decompress(titlePart);
            }
            qr.set({ value: window.location.href });
        }
    });

    // Salvataggio e aggiornamento URL
    let timeout;
    const updateAll = () => {
        clearTimeout(timeout);
        timeout = setTimeout(async () => {
            const title = titleInput.value.trim();
            const content = pad.value;
            
            if (content || title) {
                const compressedContent = await compress(content);
                // Il titolo viene lasciato leggibile (URL encoded)
                const newHash = encodeURIComponent(title) + "|" + compressedContent;
                window.history.replaceState(null, null, "#" + newHash);
                qr.set({ value: window.location.href });
            } else {
                window.history.replaceState(null, null, window.location.pathname);
            }
        }, 400);
    };

    titleInput.addEventListener('input', updateAll);
    pad.addEventListener('input', updateAll);
    qrBtn.addEventListener('click', () => qrContainer.classList.toggle('show'));
</script>

</body>
</html>
